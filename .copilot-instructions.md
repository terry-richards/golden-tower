# Golden Tower — Autonomous Hydroponic Grow Tower Design System

## Copilot Instructions for Claude Agent Swarm

> These instructions define the mission, constraints, roles, and iteration
> protocol for a zero-human autonomous agent swarm that designs, validates,
> and prepares for 3D printing an elegant, functional, modular hydroponic
> grow tower based on the golden angle spiral.

---

## 1. Mission Statement

Design and iterate on a **modular, 3D-printable hydroponic grow tower** system
that is:

- **Elegant** — visually striking; the golden-angle spiral should be obvious
  and beautiful when assembled.
- **Attractive** — organic, smooth curves; no visible seams when interlocked;
  appealing as indoor furniture / living sculpture.
- **Highly functional** — reliable nutrient-film or drip irrigation from a
  central tube; no leaks at joints; easy root access; simple assembly.

The swarm operates **without human intervention** until it reaches the
"Ready for Human Evaluation" gate (§7). All decisions, trade-offs, and
iterations are made autonomously by the agents.

---

## 2. Product Specification

### 2.1 Geometry — The Golden Angle Spiral

| Parameter | Value | Notes |
|---|---|---|
| Golden angle | **137.508°** | Successive node angular offset |
| Nodes per segment | **3** | Each segment has 3 planting pockets |
| Angular step per node | 137.508° | Nodes spiral around the central axis |
| Segment-to-segment rotation | 3 × 137.508° = 412.524° → **52.524°** net | Each new segment starts 52.524° rotated from the one below |
| Vertical pitch per node | Derived from segment height ÷ 3 | **Each pocket within a segment is at a different height**, creating a continuous upward spiral — not a flat ring |
| Segment height:width ratio | **≥ 1.0** (prefer ~1.2–1.4) | Taller segments create a visually pleasing upward sweep; the spiral must read as *ascending*, not flat |

The spiral must produce the characteristic **parastichy** pattern
(visible clockwise and counter-clockwise spirals) when multiple segments
are stacked. **Critical**: the nodes must clearly spiral *upward* — each
of the 3 pockets within a segment sits at a progressively higher Z position,
and this vertical progression continues seamlessly across the segment
boundary into the next segment. The assembled tower should look like a
helical vine, not a stack of flat rings.

Target segment count: **6–10 segments** for a full tower.

### 2.2 Component Inventory

| Component | Count per tower | Description |
|---|---|---|
| **Standard Segment** | 6–10 | 3 planting pockets spiraling at golden angle **and ascending in height**; integrated central supply tube section; integrated drip tray/catch plate; male/female interlock top/bottom; clean outer body with no accessory notches |
| **Top Cap** | 1 | Deflects water from the integrated supply tube outward and down into the topmost segment's pockets; aesthetic finial/crown |
| **Bottom Segment** | 1 | Variant of standard segment; includes a secure **lid attachment** (bayonet or threaded) for the reservoir below, and a **standard quick-disconnect fitting** (3/8″ barb or cam-lock) for pump connection |

> **Note — Integrated Supply Tube**: The central water supply tube is **built into each segment** as an integral part of the printed geometry (visible in the reference STL). There is no separate central tube component. Each segment's tube section aligns and seals with the one above/below via the interlock mechanism.

> **Note — No Accessory Notches**: The outer body of each segment must be **clean and smooth between the planting pockets** — no alignment notches, grip features, or accessory slots on the exterior surface. The planting pocket protrusions are, of course, integral to the design and expected to extend beyond the outer cylinder. All rotational alignment is handled by the internal interlock geometry, not external features.

### 2.3 Interlock System

- Segments **interlock** using a keyed twist-lock, bayonet, or dovetail
  mechanism that:
  - Enforces the correct **52.524° rotational offset** between segments.
  - Cannot be assembled at the wrong angle.
  - Is secure enough to resist accidental separation but tool-free to disassemble.
  - Maintains a **watertight or splash-resistant seal** at the joint (consider
    an O-ring groove or labyrinth seal).
- The interlock geometry must preserve the golden-angle relationship
  between planting nodes across segment boundaries.

### 2.4 Planting Pockets & Integrated Drip Tray

- Inner diameter: **50 mm** (standard 2″ net cup) — parametric, adjustable.
- Pocket angle: tilted **15–25°** outward from vertical for drainage and
  light exposure.
- **Each pocket sits at a unique height** within its segment, following the
  golden-angle helix. The vertical offset between consecutive pockets
  equals `SEGMENT_HEIGHT / NODES_PER_SEGMENT`.
- Each pocket receives water via gravity from the integrated supply tube
  deflector (top cap) or the pocket above.
- **Integrated drip tray / catch plate**: Each segment includes a built-in
  drip plate (visible in the reference STL) below the pocket openings.
  This tray collects overflow and channels it downward — either to the
  next pocket in the spiral or back through the central drain path to
  the reservoir. The drip tray is an integral part of the segment body,
  not a separate component.

### 2.5 Water Flow

```
Pump → Quick-disconnect → Bottom segment → Integrated supply tube (up)
  → Top cap deflector → Drips/flows down outer spiral pockets
  → Drip trays catch overflow → Drains back to reservoir
```

- Flow rate target: **1–4 L/min** (typical small hydroponic pump).
- The top cap must redirect 100% of the water outward — no pooling.
- Each pocket-to-pocket transition must avoid stagnant zones.
- The integrated supply tube carries water up through each segment;
  the tube sections align and seal at segment joints.
- Drip trays within each segment ensure no nutrient solution is wasted —
  all overflow is captured and routed downward.

### 2.6 3D Printing Constraints

| Constraint | Value |
|---|---|
| Target printer bed | **256 × 256 × 256 mm** (Bambu Lab P1S / similar) |
| Max segment height | Fit within 256 mm build height |
| Material | PETG (food-safe, UV-resistant) or ASA |
| Wall thickness min | **1.6 mm** (2 perimeters at 0.4 mm nozzle) |
| Overhangs | ≤ 55° from vertical without supports |
| Print orientation | Segment prints upright (pockets pointing outward) |
| No supports preferred | Design self-supporting geometry; bridging ≤ 40 mm |
| Watertight | Minimum 3 perimeters for water-contact surfaces; design for vase-mode where possible |

### 2.7 Materials & Fittings

- **Quick-disconnect**: Standard 3/8″ garden hose QD or cam-lock.
  Model the socket geometry so it press-fits or threads onto the printed part.
- **O-rings**: Standard AS568 sizes for seals (specify dash number in BOM).
- **Net cups**: Standard 2″ (50 mm) hydroponic net cups.

---

## 3. Technology Stack

| Tool | Purpose |
|---|---|
| **build123d** | Parametric 3D CAD kernel (Python API) |
| **OCP CAD Viewer** (ocp_vscode) | Visual validation in VS Code |
| **CadQuery** | Alternate/supplemental CAD operations |
| **NumPy** | Geometric calculations, golden angle math |
| **trimesh** | STL mesh analysis (watertight checks, volume) |
| **OpenSCAD** (optional) | Cross-validation of geometry |
| **PrusaSlicer CLI** or **BambuStudio CLI** | Slicing validation, print-time estimation |
| **pytest** | Automated geometry & constraint tests |
| **git** | Version control for every iteration |
| **GitHub** | Remote repository: `terry-richards/golden-tower` |

All scripts live in `/home/tmr/src/learn/golden-tower/`.
Virtual environment: `./venv/` with build123d already installed.

**GitHub Repository**: https://github.com/terry-richards/golden-tower
Remote: `origin` → `https://github.com/terry-richards/golden-tower.git`
Default branch: `main`

---

## 4. Agent Roles

### 4.1 Architect Agent

**Responsibility**: High-level design decisions, parametric model structure,
and **applied hydroponic systems engineering**.

The Architect must apply expert-level knowledge of hydroponic growing systems,
including:
- **Nutrient Film Technique (NFT)** and drip irrigation flow dynamics.
- Optimal root zone exposure — pocket angle, depth, and drainage rates.
- Nutrient solution pH/EC management implications on material choice.
- Plant spacing and light interception angles for leafy greens, herbs, and
  compact fruiting plants (lettuce, basil, strawberries, peppers).
- How root mass affects drainage over time — pockets must remain functional
  when roots fill 80% of the net cup volume.
- Reservoir sizing and pump head calculations for the target tower height.

Core responsibilities:
- Owns the parametric model definition (`tower_params.py`).
- Defines the golden-angle math, segment geometry, interlock mechanism.
- Ensures each segment's 3 pockets **spiral upward at different heights**
  (not a flat ring) — the vertical helix must be visually continuous.
- Designs the **integrated supply tube** as part of each segment body.
- Designs the **integrated drip tray** for overflow capture.
- Ensures the outer segment body is **clean between pockets** — no accessory
  notches, grip textures, or external alignment features. Planting pocket
  protrusions are expected and integral to the design.
- Makes trade-off decisions (e.g., pocket angle vs. printability).
- Writes the master `build_tower.py` script using build123d.
- Outputs: STEP files, STL files, parameter configs.

### 4.2 Engineering Agent

**Responsibility**: Structural integrity, water flow, and mechanical validation.

- Analyzes wall thickness, overhang angles, bridging distances.
- Validates interlock strength (basic FEA reasoning or geometric analysis).
- Ensures water channels have correct slope (minimum 2° grade).
- Checks pocket drainage paths for dead zones.
- Runs `trimesh` watertight checks on exported STLs.
- Outputs: Validation reports, issue lists, fix recommendations.

### 4.3 Print Agent

**Responsibility**: 3D printing feasibility and optimization.

- Validates all parts fit within build volume.
- Checks for support-free printability (overhang analysis).
- Estimates print time and material usage.
- Suggests orientation changes if needed.
- Generates recommended slicer profiles / settings.
- Outputs: Print feasibility reports, slicer configs.

### 4.4 Aesthetics Agent

**Responsibility**: Visual design quality and elegance.

- Evaluates whether the golden-angle spiral is visually apparent.
- Suggests fillet radii, chamfers, and organic curves.
- Reviews proportions (segment height vs. width, pocket size vs. body).
- Ensures the assembled tower looks cohesive and sculptural.
- Checks that interlock seams are visually minimal.
- Outputs: Aesthetic review, suggested refinements.

### 4.5 Integration & Test Agent

**Responsibility**: End-to-end validation and iteration orchestration.

- Runs the full test suite (`pytest`) after each iteration.
- Validates BOM completeness (all off-the-shelf parts specified).
- Checks that all agents' outputs are consistent.
- Maintains the iteration log (`CHANGELOG.md`).
- **Decides** whether to iterate or promote to "Ready for Human Evaluation."
- Outputs: Test results, iteration decision, final deliverables package.

---

## 5. File Structure

```
golden-tower/
├── .copilot-instructions.md     ← This file
├── AGENTS.md                    ← Swarm orchestration config
├── CHANGELOG.md                 ← Auto-maintained iteration log
├── README.md                    ← Project overview & assembly guide
├── tower_params.py              ← All parametric dimensions (single source of truth)
├── build_tower.py               ← Main build123d script
├── components/
│   ├── segment.py               ← Standard segment (pockets + integrated tube + drip tray)
│   ├── top_cap.py               ← Top cap / water deflector
│   ├── bottom_segment.py        ← Bottom segment with QD fitting
│   └── interlock.py             ← Interlock mechanism geometry
├── tests/
│   ├── test_geometry.py         ← Golden angle validation
│   ├── test_printability.py     ← Build volume, overhangs, wall thickness
│   ├── test_watertight.py       ← Mesh integrity checks
│   ├── test_interlock.py        ← Fit tolerance and alignment
│   └── test_assembly.py         ← Full tower stack validation
├── exports/
│   ├── stl/                     ← STL files per component
│   ├── step/                    ← STEP files per component
│   └── renders/                 ← Screenshot / viewport captures
├── reports/
│   ├── engineering_review.md
│   ├── print_feasibility.md
│   ├── aesthetic_review.md
│   └── iteration_summary.md
└── slicer/
    └── profiles/                ← Slicer config files
```

---

## 6. Iteration Protocol

### 6.1 Iteration Cycle

```
┌─────────────────────────────────────────────────────────┐
│  1. Architect designs / modifies parametric model        │
│  2. Engineering validates structure & water flow          │
│  3. Print agent validates manufacturability               │
│  4. Aesthetics agent reviews visual quality               │
│  5. Integration agent runs full test suite                │
│  6. Decision: ITERATE (go to 1) or PROMOTE (go to 7)    │
│  7. Package deliverables → Ready for Human Evaluation    │
└─────────────────────────────────────────────────────────┘
```

### 6.2 Iteration Rules

1. **Maximum iterations**: 12 per design cycle. If not converging, write a
   summary of unresolved issues and promote for human input.
2. **Each iteration must improve** at least one metric without regressing
   others. If a trade-off is required, document it in the changelog.
3. **No agent may override** another agent's domain without documenting
   the rationale.
4. **All geometry changes** must be made in the parametric model
   (`tower_params.py` + component scripts), never by manual STL editing.
5. **Every iteration** produces a git commit with a descriptive message
   and is **pushed to GitHub** (`git push origin main`).

### 6.3 Scoring Rubric (0–10 per category)

| Category | Weight | Criteria |
|---|---|---|
| **Golden Angle Accuracy** | 20% | Nodes at exactly 137.508° apart; parastichy visible |
| **Printability** | 20% | No supports needed; fits build volume; watertight mesh |
| **Water Flow** | 20% | Complete flow path; no dead zones; proper drainage |
| **Structural Integrity** | 15% | Interlock holds; wall thickness adequate; stable when stacked |
| **Aesthetics** | 15% | Elegant curves; minimal seams; visually striking spiral |
| **Assembly Ease** | 10% | Tool-free; intuitive; cannot be assembled wrong |

**Promotion threshold**: Weighted score ≥ **7.5 / 10** with no category below 6.

---

## 7. Ready for Human Evaluation — Deliverables

When the Integration Agent promotes a design, the following must exist:

- [ ] All STL files in `exports/stl/` (one per printable component)
- [ ] All STEP files in `exports/step/` (for further CAD work)
- [ ] `README.md` with assembly instructions and BOM
- [ ] `CHANGELOG.md` with full iteration history
- [ ] All reports in `reports/` filled out
- [ ] `tower_params.py` fully commented with every dimension explained
- [ ] Test suite passing: `pytest tests/ -v` all green
- [ ] Final weighted score documented in `reports/iteration_summary.md`
- [ ] Git tagged as `v{iteration}-ready-for-review` and pushed to GitHub
- [ ] All changes pushed to `origin/main`

---

## 8. Parametric Defaults

```python
# tower_params.py — starting values (all dimensions in mm)
GOLDEN_ANGLE = 137.50776405003785  # degrees (exact: 360 / φ²)

# Segment — pockets spiral UPWARD within each segment
NODES_PER_SEGMENT = 3
SEGMENT_HEIGHT = 200.0        # mm — tall enough for visible upward spiral
SEGMENT_OUTER_DIAMETER = 160.0  # mm — max outer envelope
SUPPLY_TUBE_OD = 32.0        # mm — integrated supply tube outer diameter
SUPPLY_TUBE_ID = 28.0        # mm — integrated supply tube inner diameter
WALL_THICKNESS = 2.0           # mm — minimum wall thickness
OUTER_BODY_STYLE = "clean"    # no accessory notches on exterior

# Planting Pocket
POCKET_DIAMETER = 52.0         # mm — for 2" net cup with clearance
POCKET_TILT_ANGLE = 20.0       # degrees from vertical
POCKET_DEPTH = 45.0            # mm

# Interlock
INTERLOCK_HEIGHT = 10.0        # mm — engagement depth
INTERLOCK_CLEARANCE = 0.3      # mm — printer tolerance gap
INTERLOCK_ROTATION = (NODES_PER_SEGMENT * GOLDEN_ANGLE) % 360  # 52.524°

# Water Flow
CHANNEL_WIDTH = 8.0            # mm
CHANNEL_DEPTH = 3.0            # mm
CHANNEL_SLOPE = 3.0            # degrees minimum grade

# Top Cap
CAP_DEFLECTOR_ANGLE = 30.0     # degrees — cone half-angle
CAP_OVERHANG = 10.0            # mm — beyond outer diameter

# Bottom Segment
QD_FITTING_ID = 10.0           # mm — 3/8" barb inner bore
LID_ATTACHMENT_TYPE = "bayonet"  # or "threaded"
LID_THREAD_PITCH = 3.0         # mm (if threaded)

# Print
BUILD_VOLUME = (256, 256, 256)  # mm — target printer
LAYER_HEIGHT = 0.2              # mm
NOZZLE_DIAMETER = 0.4           # mm
```

---

## 9. Key Design Patterns for build123d

```python
# Golden angle node placement pattern
import math
from build123d import *

GOLDEN_ANGLE_RAD = math.radians(137.50776405003785)

def place_nodes(n_nodes, radius, segment_height):
    """Generate (x, y, z, angle) positions for n nodes following golden angle.
    
    CRITICAL: Each node is at a DIFFERENT height within the segment.
    The vertical pitch = segment_height / n_nodes. This creates the
    upward spiral — not a flat ring of pockets.
    """
    vertical_pitch = segment_height / n_nodes
    positions = []
    for i in range(n_nodes):
        angle = i * GOLDEN_ANGLE_RAD
        z = i * vertical_pitch  # each pocket at a different height!
        x = radius * math.cos(angle)
        y = radius * math.sin(angle)
        positions.append((x, y, z, math.degrees(angle)))
    return positions

# Full tower: node positions across all segments
def place_all_nodes(n_segments, nodes_per_seg, radius, segment_height):
    """Place all nodes across all segments, maintaining continuous helix."""
    all_pos = []
    for seg in range(n_segments):
        seg_offset_z = seg * segment_height
        seg_offset_angle = seg * nodes_per_seg * GOLDEN_ANGLE_RAD
        for i in range(nodes_per_seg):
            global_idx = seg * nodes_per_seg + i
            angle = global_idx * GOLDEN_ANGLE_RAD
            z = seg_offset_z + i * (segment_height / nodes_per_seg)
            x = radius * math.cos(angle)
            y = radius * math.sin(angle)
            all_pos.append((x, y, z, math.degrees(angle), seg, i))
    return all_pos
```

---

## 10. Quality Gates (Automated Tests)

### test_geometry.py
- Assert angular offset between consecutive nodes == 137.508° ± 0.01°
- Assert segment-to-segment rotation == 52.524° ± 0.01°
- Assert parastichy count matches Fibonacci pair (3, 5) or (5, 8)

### test_printability.py
- Assert all parts fit within BUILD_VOLUME
- Assert minimum wall thickness ≥ 1.6 mm everywhere
- Assert maximum overhang angle ≤ 55°
- Assert maximum bridge span ≤ 40 mm
- Assert mesh is manifold and watertight (trimesh)

### test_watertight.py
- Assert all water-contact surfaces are closed meshes
- Assert channel connectivity from top cap to bottom drain

### test_interlock.py
- Assert male/female geometry overlap == 0 at INTERLOCK_CLEARANCE
- Assert rotation lock angle matches INTERLOCK_ROTATION
- Assert segments cannot assemble at wrong angle (interference check)

### test_assembly.py
- Assert N segments stack to expected total height
- Assert all pockets are accessible (no collision with adjacent segments)
- Assert integrated supply tube sections align across segment joints
- Assert nodes spiral upward (each successive node has greater Z)
- Assert segment height:width ratio ≥ 1.0

---

## 11. Error Handling & Recovery

- If build123d throws a geometry error → simplify the operation, add
  intermediate construction steps, log the error and the fix.
- If a mesh fails watertight check → increase wall thickness or add
  fillets to thin regions; re-export and re-test.
- If part exceeds build volume → reduce SEGMENT_HEIGHT or
  SEGMENT_OUTER_DIAMETER; document the change.
- If interlock is too tight/loose → adjust INTERLOCK_CLEARANCE in 0.05 mm
  increments.
- If aesthetic score is low → add fillets (min radius 2 mm), smooth
  transitions, and organic curves to pocket openings.

---

## 12. Communication Protocol Between Agents

Agents communicate through **files in the repository**:

- Design changes → commit to git with `[architect]` prefix and push to GitHub
- Reviews → write to `reports/` with `[engineering]`, `[print]`, `[aesthetics]` prefix
- Issues → create entries in `reports/iteration_summary.md` with severity:
  - **BLOCKER**: Must fix before promotion (score < 6 in any category)
  - **MAJOR**: Should fix; affects score significantly
  - **MINOR**: Nice to have; cosmetic or optimization
- Decisions → Integration agent writes `DECISION:` entries to changelog

---

## 13. Glossary

| Term | Definition |
|---|---|
| **Golden angle** | 137.508°; the angle that produces the most uniform distribution of points around a circle |
| **Parastichy** | Visible spiral pattern in phyllotactic arrangements; count follows Fibonacci sequence |
| **Net cup** | Slotted plastic cup used in hydroponics to hold growing medium and plant roots |
| **NFT** | Nutrient Film Technique — thin film of nutrient solution flows over roots |
| **Drip tray / catch plate** | Integrated basin within each segment that collects overflow nutrient solution and channels it downward |
| **Integrated supply tube** | Central water supply tube built into each segment as part of the printed body (not a separate component) |
| **Quick-disconnect (QD)** | Tool-free hose coupling with shut-off valve |
| **build123d** | Python-based parametric CAD library built on OpenCascade |
| **Manifold mesh** | A 3D mesh with no holes, self-intersections, or non-manifold edges — required for 3D printing |
